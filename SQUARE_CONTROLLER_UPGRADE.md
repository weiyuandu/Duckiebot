# Square Controller çŠ¶æ€æœºæ”¹è¿›è¯´æ˜

## ğŸ”„ æ”¹è¿›æ¦‚è¦

æ‚¨çš„ `square_controller_node.py` å·²æˆåŠŸä»**å¼€ç¯æ—¶é—´æ§åˆ¶**æ”¹å†™ä¸º**é—­ç¯çŠ¶æ€æœºæ§åˆ¶**ï¼

## ğŸ“Š ä¸»è¦å˜åŒ–å¯¹æ¯”

### åŸç‰ˆæœ¬ (å¼€ç¯æ§åˆ¶)
```python
# åŸºäºæ—¶é—´çš„æ§åˆ¶
def move_forward(self, duration):
    end_time = rospy.Time.now() + rospy.Duration(duration)
    while rospy.Time.now() < end_time:
        self.publish_car_cmd(self._linear_velocity, 0.0)

def turn_left(self, duration):
    end_time = rospy.Time.now() + rospy.Duration(duration)
    while rospy.Time.now() < end_time:
        self.publish_car_cmd(0.0, self._angular_velocity)
```

### æ–°ç‰ˆæœ¬ (çŠ¶æ€æœº + ç¼–ç å™¨åé¦ˆ)
```python
# åŸºäºè·ç¦»/è§’åº¦çš„ç²¾ç¡®æ§åˆ¶
def _do_straight_side(self, side_num):
    distance_traveled = self.dist - self.segment_start_dist
    if distance_traveled >= self.side_length - self.dist_threshold:
        self._set_state(next_turn_state)  # ç²¾ç¡®åˆ‡æ¢çŠ¶æ€

def _do_turn(self, turn_num):
    angle_diff = self._calculate_angle_diff(self.theta_curr, target_angle)
    if abs(angle_diff) <= self.angle_threshold:
        self._set_state(next_state)  # ç²¾ç¡®è§’åº¦æ§åˆ¶
```

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### 1. **çŠ¶æ€æœºæ¶æ„**
- **9ä¸ªçŠ¶æ€**: `STOP`, `SIDE1-4`, `TURN1-4`, `COMPLETE`
- **æ¸…æ™°çš„çŠ¶æ€è½¬æ¢**: åŸºäºå®é™…æµ‹é‡å€¼è€Œéæ—¶é—´
- **LEDæŒ‡ç¤º**: ä¸åŒçŠ¶æ€æ˜¾ç¤ºä¸åŒé¢œè‰²

### 2. **ç²¾ç¡®å®šä½ç³»ç»Ÿ**
- **ç¼–ç å™¨é‡Œç¨‹è®¡**: å®æ—¶è®¡ç®— (x, y, Î¸) ä½ç½®
- **è¿åŠ¨å­¦æ¨¡å‹**: ä½¿ç”¨ `odometry_activity.py` çš„å·®åˆ†é©±åŠ¨ç®—æ³•
- **ç´¯è®¡è·ç¦»è·Ÿè¸ª**: ç²¾ç¡®æµ‹é‡æ¯æ¡è¾¹çš„è¡Œé©¶è·ç¦»

### 3. **é—­ç¯æ§åˆ¶**
- **è·ç¦»æ§åˆ¶**: æ¯è¾¹ç²¾ç¡®1ç±³ (Â±5cmé˜ˆå€¼)
- **è§’åº¦æ§åˆ¶**: 90Â°è½¬å¼¯ (Â±5Â°é˜ˆå€¼)
- **å®æ—¶ä¿®æ­£**: ç›´çº¿è¡Œé©¶æ—¶çš„è§’åº¦ä¿®æ­£

### 4. **æ•°æ®è®°å½•**
- **rosbagè®°å½•**: ä¿å­˜å®Œæ•´è½¨è¿¹æ•°æ®
- **è¯¦ç»†æ—¥å¿—**: å®æ—¶çŠ¶æ€å’Œä½ç½®ä¿¡æ¯
- **æ€§èƒ½ç»Ÿè®¡**: æ€»æ—¶é—´å’Œæœ€ç»ˆä½ç½®

## ğŸ”§ å…³é”®å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|----|----|
| `side_length` | 1.0m | æ–¹å½¢è¾¹é•¿ |
| `speed_gain` | 0.4 m/s | çº¿é€Ÿåº¦ |
| `steer_gain` | 2.0 rad/s | è½¬å¼¯è§’é€Ÿåº¦ |
| `correction_gain` | 3.0 | ç›´çº¿ä¿®æ­£å¢ç›Š |
| `dist_threshold` | 0.05m | è·ç¦»é˜ˆå€¼ (5cm) |
| `angle_threshold` | 5Â° | è§’åº¦é˜ˆå€¼ |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è¿è¡ŒçŠ¶æ€æœºç‰ˆæœ¬
```bash
roslaunch my_package square_controller_state_machine.launch
```

### è¿è¡Œencoderé›†æˆç‰ˆæœ¬
```bash
roslaunch my_package square_encoder.launch
```

## ğŸ“ˆ ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | åŸç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|------|--------|--------|
| **æ§åˆ¶æ–¹å¼** | å¼€ç¯æ—¶é—´ | é—­ç¯åé¦ˆ |
| **ç²¾åº¦** | ä½ (ç´¯ç§¯è¯¯å·®) | é«˜ (å®æ—¶æ ¡æ­£) |
| **é²æ£’æ€§** | å·® (ç¯å¢ƒæ•æ„Ÿ) | å¥½ (è‡ªé€‚åº”) |
| **å¯è°ƒæ€§** | å›ºå®šå‚æ•° | å¤šçº§å‚æ•° |
| **è°ƒè¯•æ€§** | æœ‰é™ | è¯¦ç»†æ—¥å¿— |
| **æ•°æ®è®°å½•** | æ—  | å®Œæ•´è½¨è¿¹ |

## ğŸ® çŠ¶æ€æœºæµç¨‹

```
STOP (çº¢è‰²LED)
  â†“
SIDE1 (ç»¿è‰²LED) â†’ ç§»åŠ¨1ç±³ 
  â†“
TURN1 (è“è‰²LED) â†’ å·¦è½¬90Â°
  â†“
SIDE2 (ç»¿è‰²LED) â†’ ç§»åŠ¨1ç±³
  â†“
TURN2 (è“è‰²LED) â†’ å·¦è½¬90Â°
  â†“
SIDE3 (ç»¿è‰²LED) â†’ ç§»åŠ¨1ç±³
  â†“
TURN3 (è“è‰²LED) â†’ å·¦è½¬90Â°
  â†“
SIDE4 (ç»¿è‰²LED) â†’ ç§»åŠ¨1ç±³
  â†“
TURN4 (è“è‰²LED) â†’ å·¦è½¬90Â°
  â†“
COMPLETE (ç™½è‰²LED) â†’ å®Œæˆå¹¶å…³æœº
```

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### ç¼–ç å™¨é›†æˆ
- è®¢é˜…å·¦å³è½®ç¼–ç å™¨ `/tick` è¯é¢˜
- ä½¿ç”¨ `odometry_activity.delta_phi()` è®¡ç®—è½®å­è½¬è§’
- ä½¿ç”¨ `odometry_activity.estimate_pose()` è®¡ç®—ä½å§¿

### çŠ¶æ€ç®¡ç†
- æ¯ä¸ªçŠ¶æ€æœ‰ç‹¬ç«‹çš„æ§åˆ¶é€»è¾‘
- ä½¿ç”¨å±æ€§æ ‡å¿—è·Ÿè¸ªçŠ¶æ€è¿›åº¦
- æ™ºèƒ½çŠ¶æ€è½¬æ¢åŸºäºæµ‹é‡é˜ˆå€¼

### å®æ—¶ä¿®æ­£
- ç›´çº¿è¡Œé©¶æ—¶çš„è§’åº¦ä¿®æ­£
- è½¬å¼¯æ—¶çš„ç²¾ç¡®è§’åº¦æ§åˆ¶
- å¯è°ƒèŠ‚çš„æ§åˆ¶å¢ç›Š

## ğŸ¯ è°ƒè¯•å»ºè®®

1. **è§‚å¯ŸLEDé¢œè‰²** - äº†è§£å½“å‰çŠ¶æ€
2. **æŸ¥çœ‹æ—¥å¿—è¾“å‡º** - ç›‘æ§è·ç¦»å’Œè§’åº¦è¿›åº¦
3. **åˆ†ærosbagæ•°æ®** - éªŒè¯è½¨è¿¹ç²¾åº¦
4. **è°ƒæ•´å‚æ•°** - æ ¹æ®å®é™…è¡¨ç°ä¼˜åŒ–

è¿™ä¸ªçŠ¶æ€æœºç‰ˆæœ¬å°†ä¸ºæ‚¨æä¾›æ›´ç²¾ç¡®ã€æ›´å¯é çš„æ–¹å½¢è·¯å¾„æ§åˆ¶ï¼ ğŸ‰
